<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatbot</title>
  <!-- Bu sayfa, ÅŸirket iÃ§i chatbot arayÃ¼zÃ¼nÃ¼ sunar: mesajlaÅŸma, SSS, puanlama -->
  <!-- Bootstrap 5 (stil ve grid sistemi iÃ§in) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Tema renkleri ve temel gÃ¶rsel deÄŸiÅŸkenler */
    :root{
      --bg: #0b0f13;
      --card: #11161c;
      --soft: #1b242d;
      --text: #e9eef4;
      --muted: #9fb0c0;
      --accent: #4da3ff;
      --user: #1f6feb;
      --bot: #2b825b;
    }
    /* Arka plan ve metin rengi */
    body{background: linear-gradient(180deg, #0a0f14 0%, #0b1116 100%); color: var(--text);} 
    .app{max-width: 900px; margin: 40px auto;}
    /* Cam efekti kart (ana kap) */
    .glass{background: rgba(17, 22, 28, 0.75); backdrop-filter: blur(8px); border: 1px solid #1e2630; border-radius: 16px;}
    /* Ãœst baÅŸlÄ±k alanÄ± */
    .chat-header{border-bottom: 1px solid #1e2630;}
    .chat-title{font-weight: 600; letter-spacing: .3px;}
    /* Mesaj listesi ve baloncuklar */
    .message-list{height: 56vh; overflow-y: auto; padding: 20px;}
    .msg{display: flex; gap: 12px; margin-bottom: 14px;}
    .msg .bubble{max-width: 75%; padding: 12px 14px; border-radius: 14px; line-height: 1.4; font-size: 14.5px;}
    .msg.user .bubble{background: rgba(31,111,235,.15); border: 1px solid rgba(31,111,235,.35);} 
    .msg.bot .bubble{background: rgba(43,130,91,.16); border: 1px solid rgba(43,130,91,.35);} 
    /* Avatar (kullanÄ±cÄ±/bot simgesi) */
    .avatar{
      width: 34px; height: 34px; border-radius: 50%; display: grid; place-items: center;
      overflow: hidden; background: rgba(255,255,255,.06); border: 1px solid #223043;
    }
    .avatar img{ width: 100%; height: 100%; object-fit: cover; display: block; }
    .avatar svg{ width: 22px; height: 22px; }
    .avatar.user{background: var(--user);} .avatar.bot{background: var(--bot);} 
    /* GiriÅŸ Ã§ubuÄŸu ve metin alanÄ± */
    .input-bar{border-top: 1px solid #1e2630;}
    textarea{resize: none;}
    /* SSS (FAQ) link ve buton stilleri */
    .faq a{color: var(--accent); text-decoration: none;} .faq a:hover{text-decoration: underline;}
    .faq-grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px;}
    .faq-btn{
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #1e2630;
      background: linear-gradient(180deg, #0f151c 0%, #0c1218 100%);
      color: var(--text); text-align: left; font-size: 14px; line-height: 1.3;
      transition: transform .08s ease, box-shadow .15s ease, border-color .15s ease;
      cursor: pointer;
    }
    .faq-btn:hover{ transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,.25); border-color: #2a3543; }
    .faq-btn:active{ transform: translateY(0); box-shadow: none; }
    @media (max-width: 420px){ .faq-grid{grid-template-columns: 1fr;} }
    /* Puanlama yÄ±ldÄ±zlarÄ± ve rozet/pil stili */
    .rating .star{font-size: 22px; cursor: pointer; color: #9aa9b7;} .rating .star.selected{color: #ffd166;}
    .pill{background: #10161d; border: 1px solid #1e2630; padding: 6px 10px; border-radius: 999px; color: var(--muted); font-size: 12.5px;}
    .status{color: var(--muted); font-size: 13px;}
    /* UyarÄ± kutusu (kÄ±sÄ±tlÄ±/yasak konu vb.) */
    .warning{background: rgba(255,193,7,.1); border: 1px solid rgba(255,193,7,.35); color: #ffda6a; border-radius: 10px; padding: 10px;}
  </style>
</head>
<body>
  <div class="app">
    <div class="glass">
      <!-- BaÅŸlÄ±k ve kontrol butonlarÄ± -->
      <div class="p-3 d-flex justify-content-between align-items-center chat-header">
        <div>
          <div class="chat-title">Åirket AsistanÄ±</div>
          <div class="status">Merhaba! Sorunu yaz, ben yardÄ±mcÄ± olayÄ±m.</div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="pill" id="modePill">âœ¨ Modern Tema</span>
          <button id="endChatBtn" class="btn btn-outline-warning btn-sm">KonuÅŸmayÄ± Bitir</button>
          <button id="restartChatBtn" class="btn btn-success btn-sm" style="display:none;">KonuÅŸmayÄ± BaÅŸlat</button>
        </div>
      </div>

      <!-- SSS / HÄ±zlÄ± Ã–neriler -->
      <div id="faqBox" class="p-3 border-bottom faq">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong>SÄ±k Sorulan Sorular</strong>
          <small class="text-secondary">TÄ±kla ve gÃ¶nder</small>
        </div>
        <div id="faqGrid" class="faq-grid"></div>
      </div>

      <!-- Mesaj listesi -->
      <div class="message-list" id="response"></div>

      <!-- Puanlama -->
      <div id="ratingBox" class="p-3 rating" style="display:none;">
        <div class="fw-semibold mb-2">Bu konuÅŸmayÄ± puanla:</div>
        <span class="star" data-v="1">â˜…</span>
        <span class="star" data-v="2">â˜…</span>
        <span class="star" data-v="3">â˜…</span>
        <span class="star" data-v="4">â˜…</span>
        <span class="star" data-v="5">â˜…</span>
        <span id="rateMsg" class="ms-2 text-secondary"></span>
      </div>

      <!-- GiriÅŸ Ã‡ubuÄŸu -->
      <div class="input-bar p-3">
        <div class="row g-2 align-items-end" id="chatBox">
          <div class="col-12 col-md-9">
            <textarea id="userInput" rows="3" class="form-control" placeholder="MesajÄ±nÄ± yaz... (Enter: GÃ¶nder, Shift+Enter: SatÄ±r)"></textarea>
          </div>
          <div class="col-12 col-md-3 d-grid d-md-flex gap-2">
            <button id="sendBtn" type="button" class="btn btn-primary flex-fill">GÃ¶nder</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (opsiyonel â€“ odak/eriÅŸilebilirlik iÃ§in) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- Durum deÄŸiÅŸkenleri (gÃ¶nderim & oturum) ---
    let isSending = false;
    let isChatActive = true;

    // --- SÄ±k kullanÄ±lan DOM referanslarÄ± ---
    const sendBtn   = document.getElementById("sendBtn");
    const inputEl   = document.getElementById("userInput");
    const restartBtn= document.getElementById("restartChatBtn");
    const ratingBox = document.getElementById("ratingBox");
    const rateMsg   = document.getElementById("rateMsg");
    const modePill  = document.getElementById("modePill");
    const stars     = () => document.querySelectorAll('#ratingBox .star');  // YÄ±ldÄ±zlarÄ± canlÄ± seÃ§
    let ratingLocked = false;

    // Ä°steÄŸe baÄŸlÄ±: Ã¶zel avatar gÃ¶rselleri (boÅŸ bÄ±rakÄ±lÄ±rsa yerleÅŸik ikonlar kullanÄ±lÄ±r)
    const USER_AVATAR_URL = ""; // Ã¶rn. "./assets/user.jpg"
    const BOT_AVATAR_URL  = ""; // Ã¶rn. "./assets/bot.png"

    function createAvatar(role){  // Avatar HTML'ini Ã¼retir (resim varsa resim, yoksa SVG)
      const avatar = document.createElement('div');
      avatar.className = `avatar ${role}`;
      const url = role === 'user' ? USER_AVATAR_URL : BOT_AVATAR_URL;
      if (url) {
        const img = document.createElement('img');
        img.src = url; img.alt = role === 'user' ? 'user' : 'bot';
        avatar.appendChild(img);
      } else {
        // Dahili SVG ikonlar (kullanÄ±cÄ±=kiÅŸi, bot=robot)
        avatar.innerHTML = role === 'user'
          ? `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.42 0-8 2.24-8 5v1a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-1c0-2.76-3.58-5-8-5z"/></svg>`
          : `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a1 1 0 0 1 1 1v1h3a1 1 0 0 1 0 2h-1v2.09A6 6 0 0 1 19 14v5a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3v-5a6 6 0 0 1 4-5.91V6H8a1 1 0 0 1 0-2h3V3a1 1 0 0 1 1-1zm-4 11a2 2 0 1 0 2 2 2 2 0 0 0-2-2zm8 0a2 2 0 1 0 2 2 2 2 0 0 0-2-2z"/></svg>`;
      }
      return avatar;
    }

    function pushMessage(role, html){  // Mesaj balonunu sohbet listesine ekler
      const list = document.getElementById('response');
      const wrap = document.createElement('div');
      wrap.className = `msg ${role}`;
      const avatar = createAvatar(role);
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = html;
      wrap.appendChild(avatar); 
      wrap.appendChild(bubble);
      list.appendChild(wrap);
      list.scrollTop = list.scrollHeight;
    }

    function sendMessage() {  // KullanÄ±cÄ± mesajÄ±nÄ± API'ye gÃ¶nderir, yanÄ±tlarÄ± ekrana basar
      if (!isChatActive) return;
      if (isSending) return;
      isSending = true;

      const msg = inputEl.value.trim();
      if (!msg){ isSending = false; return; }

      pushMessage('user', msg);
      pushMessage('bot', 'ğŸ¤” DÃ¼ÅŸÃ¼nÃ¼yorum...');

      const prevLabel = sendBtn.textContent;
      sendBtn.disabled = true; 
      sendBtn.textContent = 'GÃ¶nderiliyorâ€¦';

      fetch("http://127.0.0.1:8000/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg })
      })
      .then(async res => {
        const contentType = res.headers.get("content-type") || "";
        if (!res.ok || !contentType.includes("application/json")) {
          const text = await res.text();
          throw new Error("Sunucudan geÃ§erli JSON alÄ±namadÄ±: " + text);
        }
        return res.json();
      })
      .then(data => {
        const list = document.getElementById('response');
        // Son bot yer tutucusunu kaldÄ±r
        const placeholders = list.querySelectorAll('.msg.bot .bubble');
        if (placeholders.length) {
          placeholders[placeholders.length-1].parentElement.remove();
        }

        if (data.rule_based) {
          pushMessage('bot', `ğŸ¯ <strong>Rule-based cevap</strong><br>${data.rule_based}`);
        }
        if (data.llm) {
          pushMessage('bot', `ğŸ¤– <strong>LLM cevabÄ±</strong><br>${data.llm}`);
        }
        const isWarning = (data.final_answer || '').includes('Bu konuda yardÄ±mcÄ± olamÄ±yorum');
        const finalHtml = isWarning
          ? `<div class="warning"><strong>âœ… GÃ¶sterilen cevap:</strong><br>${data.final_answer}</div>`
          : `<strong>âœ… GÃ¶sterilen cevap:</strong><br>${data.final_answer}`;
        pushMessage('bot', finalHtml);
        inputEl.value = '';
      })
      .catch(err => {
        pushMessage('bot', `<span class="text-warning">ğŸ›‘ Sunucudan yanÄ±t alÄ±namadÄ±.</span>`);
        console.error(err);
      })
      .finally(() => {
        isSending = false;
        sendBtn.disabled = false; 
        sendBtn.textContent = prevLabel || 'GÃ¶nder';
        inputEl.focus();
      });
    }

    // Butondan gÃ¶nderim
    document.getElementById("sendBtn").addEventListener("click", e => {  // GÃ¶nder butonu tÄ±klanÄ±nca mesajÄ± yolla
      e.preventDefault(); 
      sendMessage();
    });

    // KonuÅŸmayÄ± bitir
    document.getElementById("endChatBtn").addEventListener("click", async e => {  // Oturumu kapatÄ±r ve puanlamayÄ± aÃ§ar
      e.preventDefault();
      try {
        await fetch('http://127.0.0.1:8000/session/reset', { method: 'POST' });
      } catch (err) {
        console.warn('Session reset Ã§aÄŸrÄ±sÄ± baÅŸarÄ±sÄ±z:', err);
      }
      isChatActive = false; 
      ratingBox.style.display = 'block';
      pushMessage('bot', '<span class="text-secondary">ğŸ”’ KonuÅŸma sona erdi. Bot devre dÄ±ÅŸÄ± (hafÄ±za temizlendi).</span>');
      restartBtn.style.display = 'inline-block';
    });

    // KonuÅŸmayÄ± yeniden baÅŸlat
    restartBtn.addEventListener("click", () => {  // PuanlamayÄ± gizler ve yeni konuÅŸma baÅŸlatÄ±r
      isChatActive = true; 
      ratingBox.style.display = 'none';
      ratingLocked = false; 
      rateMsg.textContent = '';
      stars().forEach(s => { s.classList.remove('selected'); s.style.pointerEvents = 'auto'; });
      pushMessage('bot', '<span class="text-success">âœ… Bot yeniden aktifleÅŸtirildi.</span>');
      restartBtn.style.display = 'none';
    });

    function sendRating(value){  // PuanÄ± API'ye beacon/fetch ile gÃ¶nderir
      const payload = JSON.stringify({ rating: value });
      if (navigator.sendBeacon) {
        const blob = new Blob([payload], { type: 'application/json' });
        return navigator.sendBeacon('http://127.0.0.1:8000/rate', blob);
      }
      fetch('http://127.0.0.1:8000/rate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: payload }).catch(()=>{});
      return true;
    }

    function wireStars(){  // YÄ±ldÄ±z puanlama butonlarÄ±nÄ± etkinleÅŸtirir
      stars().forEach((s) => {
        s.onclick = () => {
          if (ratingLocked) return;
          const v = Number(s.dataset.v);
          if (!Number.isInteger(v) || v < 1 || v > 5) return;
          stars().forEach(x => x.classList.remove('selected'));
          for (let i=0; i<v; i++) stars()[i].classList.add('selected');
          const ok = sendRating(v);
          ratingLocked = true; 
          rateMsg.textContent = ok ? `TeÅŸekkÃ¼rler! ${v} yÄ±ldÄ±z verdiniz.` : 'GÃ¶nderilemedi.';
          stars().forEach(x => x.style.pointerEvents = 'none');
        };
      });
    }
    wireStars();

    // SSS Ã¶rnekleri
    const sampleQuestions = [
      "YÄ±llÄ±k izin sÃ¼rem ne kadar?",
      "MaaÅŸÄ±mÄ± nereden Ã¶ÄŸrenebilirim?",
      "Sigortam ne zaman baÅŸlar?",
      "Ã‡alÄ±ÅŸma saatleri nedir?",
      "Prim Ã¶demesi alÄ±yor muyum?",
      "DoÄŸum izni kaÃ§ hafta?",
      "BabalÄ±k izni kaÃ§ gÃ¼n?",
      "Evlilik izni kaÃ§ gÃ¼n?",
      "Yemek kartÄ± ne zaman yÃ¼klenir?",
      "Servis var mÄ±?"
    ];
    // Daha dÃ¼zenli gÃ¶rÃ¼nÃ¼m iÃ§in alfabetik sÄ±rala
    const sortedQuestions = [...sampleQuestions].sort((a,b)=> a.localeCompare(b, 'tr'));
    const faqGrid = document.getElementById("faqGrid");
    sortedQuestions.forEach(q => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'faq-btn';
      btn.textContent = q;
      btn.onclick = () => { inputEl.value = q; sendMessage(); };  // Butona tÄ±klayÄ±nca soruyu gÃ¶nder
      faqGrid.appendChild(btn);
    });

    // Enter / Shift+Enter davranÄ±ÅŸÄ± (Enter: gÃ¶nder, Shift+Enter: satÄ±r sonu)
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        if (e.shiftKey) return; // SatÄ±r sonu ekle
        e.preventDefault(); 
        sendMessage();
      }
    });
  </script>
</body>
</html>